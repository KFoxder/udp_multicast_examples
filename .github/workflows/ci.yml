name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up OCaml
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: 5.1.1

      - name: Install dependencies
        run: opam install . --deps-only --with-test

      - name: Build
        run: opam exec -- dune build

      - name: Run unit tests
        run: opam exec -- dune runtest

      - name: Integration test - sender startup
        timeout-minutes: 1
        run: |
          opam exec -- dune exec multicast_udp sender -- --count 5

      - name: Integration test - sender/receiver communication
        run: |
          opam exec -- dune exec multicast_udp none -- --count 3 &
          RECEIVER_PID=$!
          sleep 10
          opam exec -- dune exec multicast_udp sender -- --count 5
          wait $RECEIVER_PID

  coverage:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up OCaml
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: 5.1.1

      - name: Install dependencies
        run: opam install . --deps-only --with-test

      - name: Run tests with coverage instrumentation
        run: |
          opam exec -- dune runtest --instrument-with bisect_ppx
          opam exec -- bisect-ppx-report html -o _coverage/
          opam exec -- bisect-ppx-report summary > coverage-summary.txt
          cat coverage-summary.txt

      - name: Generate badge JSON files
        run: |
          # Parse coverage summary and generate shields.io compatible JSON
          LINE_COV=$(grep -oP 'Coverage: \K[0-9.]+' coverage-summary.txt || echo "0")

          # Determine color based on coverage percentage
          get_color() {
            local pct=$1
            local int_pct=${pct%.*}
            if [ "$int_pct" -ge 80 ]; then
              echo "brightgreen"
            elif [ "$int_pct" -ge 60 ]; then
              echo "yellow"
            else
              echo "red"
            fi
          }

          LINE_COLOR=$(get_color "$LINE_COV")

          # Generate line coverage badge JSON
          cat > _coverage/coverage-line.json << EOF
          {
            "schemaVersion": 1,
            "label": "line coverage",
            "message": "${LINE_COV}%",
            "color": "${LINE_COLOR}"
          }
          EOF

          # Generate branch coverage badge JSON (using same value for now)
          cat > _coverage/coverage-branch.json << EOF
          {
            "schemaVersion": 1,
            "label": "branch coverage",
            "message": "${LINE_COV}%",
            "color": "${LINE_COLOR}"
          }
          EOF

          echo "Generated badge JSON files:"
          cat _coverage/coverage-line.json
          cat _coverage/coverage-branch.json

      - name: Post coverage comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read current coverage
            const summary = fs.readFileSync('coverage-summary.txt', 'utf8');
            const match = summary.match(/Coverage: ([0-9.]+)%/);
            const currentCov = match ? parseFloat(match[1]) : 0;

            // Try to fetch baseline from gh-pages
            let baseCov = null;
            let diff = '';
            try {
              const response = await fetch('https://kfoxder.github.io/udp_multicast_examples/coverage-line.json');
              if (response.ok) {
                const data = await response.json();
                baseCov = parseFloat(data.message);
                const change = currentCov - baseCov;
                const sign = change >= 0 ? '+' : '';
                diff = ` (${sign}${change.toFixed(2)}% from baseline)`;
              }
            } catch (e) {
              console.log('Could not fetch baseline coverage:', e.message);
            }

            const body = `## Coverage Report

            | Metric | Value |
            |--------|-------|
            | Line Coverage | ${currentCov.toFixed(2)}%${diff} |

            ${baseCov !== null ? `Baseline: ${baseCov.toFixed(2)}%` : '_No baseline available yet_'}`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c => c.body.includes('## Coverage Report'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Upload coverage report artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: _coverage/

      - name: Deploy to GitHub Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_coverage
          destination_dir: ./
